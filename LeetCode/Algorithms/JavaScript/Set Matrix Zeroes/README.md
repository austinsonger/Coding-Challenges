First check, then set, with the complexity of O(n*m).